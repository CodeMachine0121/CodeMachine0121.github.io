---
interface Props {
  code: string;
  lang: string;
  filename?: string;
}

const { code, lang, filename } = Astro.props;
---

<div class="code-block relative my-6 overflow-hidden rounded-lg shadow-md">
  {filename && (
    <div class="code-filename bg-gray-700 px-4 py-2 text-sm text-gray-200">
      {filename}
    </div>
  )}
  <div class="code-header flex items-center justify-between bg-gray-800 px-4 py-2 text-sm text-gray-200">
    <span class="language-badge">{lang}</span>
    <button class="copy-button flex items-center rounded bg-gray-700 px-2 py-1 text-xs hover:bg-gray-600">
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
      </svg>
      複製
    </button>
  </div>
  <div class="code-content relative">
    <pre class="language-{lang} !m-0 overflow-x-auto p-4 text-sm"><code>{code}</code></pre>
    <div class="scrollbar-indicator absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-primary/40 to-transparent opacity-0 transition-opacity"></div>
  </div>
</div>

<style>
  .code-block {
    max-width: 100%;
  }

  .code-content pre {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
  }

  .code-content pre::-webkit-scrollbar {
    height: 4px;
  }

  .code-content pre::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 2px;
  }

  .code-content pre::-webkit-scrollbar-track {
    background-color: transparent;
  }

  /* 滾動指示器顯示邏輯 */
  .code-content.can-scroll .scrollbar-indicator {
    opacity: 1;
  }

  /* 移動設備優化 */
  @media (max-width: 640px) {
    .code-block {
      margin-left: -1rem;
      margin-right: -1rem;
      border-radius: 0;
    }

    .code-header {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .code-content pre {
      font-size: 0.8125rem;
      border-radius: 0;
      padding: 1rem;
    }
  }
</style>

<script>
  // 處理代碼塊的交互邏輯
  document.addEventListener('DOMContentLoaded', () => {
    const codeBlocks = document.querySelectorAll('.code-block');

    codeBlocks.forEach((block) => {
      const pre = block.querySelector('pre');
      const copyButton = block.querySelector('.copy-button');
      const codeContent = block.querySelector('.code-content');

      // 檢查是否需要水平滾動
      if (pre && codeContent) {
        const checkOverflow = () => {
          if (pre.scrollWidth > pre.clientWidth) {
            codeContent.classList.add('can-scroll');
          } else {
            codeContent.classList.remove('can-scroll');
          }
        };

        // 初始檢查
        checkOverflow();

        // 監聽窗口大小變化
        window.addEventListener('resize', checkOverflow);
      }

      // 複製代碼功能
      if (copyButton && pre) {
        copyButton.addEventListener('click', () => {
          const code = pre.textContent || '';
          navigator.clipboard.writeText(code.trim());

          // 顯示複製成功狀態
          copyButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            已複製
          `;
          copyButton.classList.add('bg-green-600');

          setTimeout(() => {
            copyButton.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
              </svg>
              複製
            `;
            copyButton.classList.remove('bg-green-600');
          }, 2000);
        });
      }
    });
  });
</script>
