---
title: "Day 4: å”ç¨‹çš„é‹è¡Œç’°å¢ƒ â€” CoroutineContext èˆ‡ Dispatchers è©³è§£"
datetime: "2026-02-14"
description: "å¦‚æœä½ çš„ App ç•«é¢å¡ä½ï¼ˆANRï¼‰ï¼Œé€šå¸¸æ˜¯å› ç‚ºä½ åœ¨ Main Thread åšäº†å¤ªé‡çš„å·¥ä½œã€‚å¦‚æœä½ çš„ App å´©æ½°å ±éŒ¯ NetworkOnMainThreadExceptionï¼Œæ˜¯å› ç‚ºä½ åœ¨ Main Thread é€£ç¶²è·¯ã€‚å¦‚æœä½ çš„ App å´©æ½°å ±éŒ¯ CalledFromWrongThreadExceptionï¼Œæ˜¯å› ç‚ºä½ åœ¨ Background Thread æ›´æ–° UIã€‚ä»Šå¤©æˆ‘å€‘è¦å­¸ç¿’å¦‚ä½•ç”¨ Dispatchers ä¾†æŒ‡æ®å”ç¨‹å»æ­£ç¢ºçš„åœ°æ–¹å·¥ä½œã€‚"
parent: "Kotlin Coroutines Bootcamp"
---
åœ¨ Kotlin å”ç¨‹ä¸­ï¼Œæˆ‘å€‘ä¸ç›´æ¥æ“ä½œ Threadï¼Œè€Œæ˜¯é€šé **Dispatcher** ä¾†æŒ‡å®šå”ç¨‹æ‡‰è©²é‹è¡Œåœ¨å“ªå€‹åŸ·è¡Œç·’æ± ä¸­ã€‚

## 1. å››å¤§ Dispatcher

Kotlin æä¾›äº†å››ç¨®æ¨™æº–çš„ Dispatcherï¼Œæ¶µè“‹äº†çµ•å¤§å¤šæ•¸çš„ä½¿ç”¨å ´æ™¯ï¼š

| Dispatcher | å°æ‡‰å ´æ™¯ | èƒŒå¾Œæ©Ÿåˆ¶ |
| :--- | :--- | :--- |
| **Dispatchers.Main** | **UI æ“ä½œ** | Android çš„ Main Looper (UI Thread)ã€‚<br>*(éœ€å¼•å…¥ `kotlinx-coroutines-android`)* |
| **Dispatchers.IO** | **I/O æ“ä½œ** | è®€å¯«æª”æ¡ˆã€è³‡æ–™åº«ã€ç¶²è·¯è«‹æ±‚ã€‚<br>é€™æ˜¯ä¸€å€‹å½ˆæ€§çš„ Thread Poolï¼Œå¯ä»¥è‡ªå‹•æ“´å±•ï¼ˆæœ€å¤š 64 å€‹åŸ·è¡Œç·’ï¼‰ã€‚ |
| **Dispatchers.Default** | **CPU å¯†é›†å‹** | è¤‡é›œé‹ç®—ã€JSON è§£æã€æ’åºç®—æ³•ã€‚<br>åŸ·è¡Œç·’æ•¸é‡ç­‰æ–¼ CPU æ ¸å¿ƒæ•¸ï¼ˆä¾‹å¦‚ 8 æ ¸æ‰‹æ©Ÿå°±æ˜¯ 8 å€‹åŸ·è¡Œç·’ï¼‰ã€‚ |
| **Dispatchers.Unconfined**| **ä¸é™åˆ¶** | **(å°‘ç”¨)** å•Ÿå‹•æ™‚è·‘åœ¨ç•¶å‰åŸ·è¡Œç·’ï¼Œæš«åœæ¢å¾©å¾Œå¯èƒ½è·‘åœ¨åˆ¥çš„åŸ·è¡Œç·’ã€‚<br>é€šå¸¸åªç”¨æ–¼æ¸¬è©¦æˆ–æ¥µç‰¹æ®Šçš„åº•å±¤é‚è¼¯ã€‚ |

### ğŸ› ï¸ å¯¦æˆ°ï¼šé¸æ“‡æ­£ç¢ºçš„ Dispatcher

```kotlin
launch(Dispatchers.Main) { 
    // é€™è£¡è·‘åœ¨ UI åŸ·è¡Œç·’ï¼Œé©åˆæ›´æ–° TextView, RecyclerView
    updateUI()
}

launch(Dispatchers.IO) {
    // é€™è£¡è·‘åœ¨èƒŒæ™¯åŸ·è¡Œç·’ï¼Œé©åˆè®€å¯« DB, API Request
    database.save(data)
}

launch(Dispatchers.Default) {
    // é€™è£¡è·‘åœ¨èƒŒæ™¯åŸ·è¡Œç·’ï¼Œé©åˆè™•ç†å¤§æ•¸æ“š
    val sortedList = heavyList.sortedBy { it.id }
}
```

---

## 2. `withContext`ï¼šå„ªé›…çš„åŸ·è¡Œç·’åˆ‡æ› (Thread Switching)

é€™æ˜¯ä»Šå¤©æœ€é‡è¦çš„é—œéµå­—ã€‚
åœ¨å‚³çµ± Android é–‹ç™¼ï¼ˆä¾‹å¦‚ AsyncTask æˆ– RxJavaï¼‰ä¸­ï¼Œåˆ‡æ›åŸ·è¡Œç·’å¾€å¾€æ„å‘³è‘— callback çš„åµŒå¥—ã€‚ä½†åœ¨å”ç¨‹ä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨ `withContext` ä¾†å¯¦ç¾ **ã€ŒåŒæ­¥å¼çš„åŸ·è¡Œç·’åˆ‡æ›ã€**ã€‚

### âŒ éŒ¯èª¤ç¤ºç¯„ï¼ˆCallback åœ°ç„å†ç¾ï¼‰

```kotlin
// å‡è¨­é€™æ˜¯å‚³çµ±å¯«æ³•
fun loadData() {
    thread(start = true) { // åˆ‡åˆ°èƒŒæ™¯
        val data = api.fetch()
        runOnUiThread { // åˆ‡å›ä¸»åŸ·è¡Œç·’
            textView.text = data
        }
    }
}
```

### âœ… å”ç¨‹å¯«æ³•ï¼ˆä¸€æ°£å‘µæˆï¼‰

`withContext` æ˜¯ä¸€å€‹ suspend å‡½æ•¸ï¼Œå®ƒæœƒï¼š
1.  **åˆ‡æ›** åˆ°æŒ‡å®šçš„ Dispatcherã€‚
2.  **åŸ·è¡Œ** ä»£ç¢¼å¡Šã€‚
3.  **ç­‰å¾…** åŸ·è¡Œå®Œç•¢ï¼ˆæš«åœå¤–éƒ¨å”ç¨‹ï¼‰ã€‚
4.  **åˆ‡å›** åŸä¾†çš„ Dispatcherï¼Œä¸¦è¿”å›çµæœã€‚

```kotlin
// å‡è¨­é€™å€‹å‡½æ•¸æ˜¯åœ¨ UI åŸ·è¡Œç·’è¢«å‘¼å«çš„
fun loadUserData() {
    scope.launch(Dispatchers.Main) {
        showLoading() // UI æ“ä½œ (Main)
        
        // åˆ‡æ›åˆ° IO åŸ·è¡Œç·’å»æŠ“è³‡æ–™
        // ä¸‹ä¸€è¡Œä»£ç¢¼æœƒ "æš«åœ" ç­‰å¾…ï¼Œç›´åˆ° IO è·‘å®Œä¸¦è¿”å›çµæœ
        val user = withContext(Dispatchers.IO) {
            println("æ­£åœ¨ IO åŸ·è¡Œç·’: ${Thread.currentThread().name}")
            api.fetchUser() // é€™æ˜¯ä¸€å€‹è€—æ™‚æ“ä½œ
        } 
        
        // è‡ªå‹•åˆ‡å› Main åŸ·è¡Œç·’
        println("å›åˆ° UI åŸ·è¡Œç·’: ${Thread.currentThread().name}")
        hideLoading() // UI æ“ä½œ (Main)
        updateUI(user)
    }
}
```

> **æœ€ä½³å¯¦è¸**ï¼š
> ä¸€å€‹è‰¯å¥½çš„ suspend å‡½æ•¸æ‡‰è©²æ˜¯ **ã€ŒMain-Safe (ä¸»åŸ·è¡Œç·’å®‰å…¨)ã€** çš„ã€‚
> ä¹Ÿå°±æ˜¯èªªï¼Œä¸ç®¡èª°å‘¼å«é€™å€‹å‡½æ•¸ï¼Œå‡½æ•¸å…§éƒ¨éƒ½æ‡‰è©²è‡ªå·±è™•ç†å¥½åŸ·è¡Œç·’åˆ‡æ›ï¼ˆä½¿ç”¨ `withContext`ï¼‰ï¼Œè€Œä¸æ‡‰è©²è®“å‘¼å«è€…æ“”å¿ƒæœƒä¸æœƒå¡æ­» UIã€‚

---

## 3. æ·±å…¥ç†è§£ï¼šä»€éº¼æ˜¯ CoroutineContextï¼Ÿ

ä½ å¯èƒ½æ³¨æ„åˆ° `launch` çš„åƒæ•¸å…¶å¯¦æ˜¯ `CoroutineContext`ã€‚
`Dispatchers.IO` åªæ˜¯ `CoroutineContext` çš„å…¶ä¸­ä¸€ç¨®å…ƒç´ ã€‚

### Context æ˜¯ä¸€å€‹ Map (é›†åˆ)
`CoroutineContext` å…¶å¯¦æ˜¯ä¸€å€‹åŒ…å«ä¸åŒå…ƒç´ çš„é›†åˆã€‚å®ƒå¯ä»¥åŒ…å«ï¼š
1.  **Job**ï¼šæ§åˆ¶å”ç¨‹ç”Ÿå‘½é€±æœŸ
2.  **Dispatcher**ï¼šæ§åˆ¶åŸ·è¡Œç·’èª¿åº¦ (ä»Šå¤©å­¸çš„)ã€‚
3.  **CoroutineName**ï¼šçµ¦å”ç¨‹å–åå­— (æ–¹ä¾¿ Debug)ã€‚
4.  **CoroutineExceptionHandler**ï¼šè™•ç†å´©æ½° (å¾ŒçºŒæœƒå†æåˆ°)ã€‚

### â• é‹ç®—ç¬¦é‡è¼‰ï¼šContext çš„åŠ æ³•

ä½ å¯ä»¥åƒæ•¸å­¸åŠ æ³•ä¸€æ¨£ï¼ŒæŠŠä¸åŒçš„é…ç½®çµ„åˆæˆä¸€å€‹ Contextï¼š

```kotlin
// çµ„åˆï¼šæˆ‘è¦ä¸€å€‹åœ¨ IO åŸ·è¡Œç·’è·‘çš„ã€åå­—å« "NetworkRequest" çš„ã€ä¸”æœ‰ç‰¹å®š Job çš„å”ç¨‹
val myContext = Dispatchers.IO + CoroutineName("NetworkRequest") + Job()

launch(myContext) {
    println("æˆ‘åœ¨ ${Thread.currentThread().name} ä¸Šé‹è¡Œ")
    // è¼¸å‡ºå¯èƒ½åŒ…å«: DefaultDispatcher-worker-1 @NetworkRequest#2
}
```

é€™åœ¨ Log è¿½è¹¤å•é¡Œæ™‚éå¸¸æœ‰ç”¨ï¼

---

## 4. çˆ¶å­å”ç¨‹çš„ç¹¼æ‰¿é—œä¿‚

ç•¶ä½ åœ¨ä¸€å€‹å”ç¨‹ A è£¡é¢å•Ÿå‹•å”ç¨‹ B æ™‚ï¼ŒB æœƒè‡ªå‹•ç¹¼æ‰¿ A çš„ Contextã€‚

```kotlin
launch(Dispatchers.Main) { // çˆ¶å”ç¨‹åœ¨ Main
    
    // å­å”ç¨‹æ²’æœ‰æŒ‡å®š Dispatcherï¼Œæ‰€ä»¥ç¹¼æ‰¿çˆ¶å”ç¨‹ -> ä¹Ÿåœ¨ Main
    launch { 
        println("æˆ‘ä¹Ÿæ˜¯ Main") 
    }
    
    // å­å”ç¨‹æŒ‡å®šäº† IOï¼Œè¦†è“‹äº†çˆ¶å”ç¨‹çš„è¨­å®š -> åœ¨ IO
    launch(Dispatchers.IO) {
        println("æˆ‘æ˜¯ IO")
    }
}
```

é€™å°±æ˜¯ç‚ºä»€éº¼åœ¨ Android ä¸­ï¼Œæˆ‘å€‘é€šå¸¸åœ¨ `ViewModel` æˆ– `Activity` æœ€å¤–å±¤å®šç¾©ä¸€å€‹ `CoroutineScope(Dispatchers.Main)`ï¼Œé€™æ¨£é è¨­æ‰€æœ‰å­ä»»å‹™éƒ½åœ¨ UI åŸ·è¡Œç·’ï¼Œåªæœ‰éœ€è¦è€—æ™‚æ“ä½œæ™‚æ‰ç”¨ `withContext(Dispatchers.IO)` åˆ‡å‡ºå»ã€‚é€™æ¨£æœ€å®‰å…¨ã€‚

---

## Day 4 ç¸½çµ

1.  **Dispatchers.Main**ï¼šUI å°ˆç”¨ï¼ˆAndroidï¼‰ã€‚
2.  **Dispatchers.IO**ï¼šè®€å¯«æ“ä½œå°ˆç”¨ï¼ˆç¶²è·¯/DBï¼‰ã€‚
3.  **Dispatchers.Default**ï¼šé‹ç®—å¯†é›†å°ˆç”¨ï¼ˆæ’åº/è§£æï¼‰ã€‚
4.  **`withContext`**ï¼šæ˜¯åˆ‡æ›åŸ·è¡Œç·’çš„ç¥å™¨ï¼Œå®ƒæœƒæš«åœç•¶å‰å”ç¨‹ï¼ŒåŸ·è¡Œå®Œå¾Œè‡ªå‹•åˆ‡å›ä¾†ã€‚
5.  **Context çµ„åˆ**ï¼š`Dispatcher + Name + Job` å¯ä»¥çµ„åˆæˆå®Œæ•´çš„é‹è¡Œç’°å¢ƒã€‚

---

### ğŸŸ¢ ä»Šæ—¥ç·´ç¿’ (Homework)

**ç›®æ¨™**ï¼šæ¨¡æ“¬ä¸€å€‹å®Œæ•´çš„åœ–ç‰‡è™•ç†æµç¨‹ã€‚

è«‹å¯«ä¸€æ®µç¨‹å¼ç¢¼ï¼Œæ¨¡æ“¬ä»¥ä¸‹æ­¥é©Ÿï¼Œä¸¦åœ¨æ¯å€‹æ­¥é©Ÿå°å‡º `Thread.currentThread().name` ä¾†é©—è­‰åŸ·è¡Œç·’æ˜¯å¦æ­£ç¢ºï¼š

1.  **UI åŸ·è¡Œç·’**ï¼šé¡¯ç¤º "é–‹å§‹ä¸‹è¼‰åœ–ç‰‡..."ã€‚
2.  **IO åŸ·è¡Œç·’**ï¼šæ¨¡æ“¬ä¸‹è¼‰åœ–ç‰‡ï¼ˆ`delay(1000)`ï¼‰ï¼Œè¿”å›ä¸€å€‹ String "Image_Data"ã€‚
3.  **Default åŸ·è¡Œç·’**ï¼šæ¨¡æ“¬åœ–ç‰‡å£“ç¸®/æ¿¾é¡è™•ç†ï¼ˆ`delay(500)`ï¼‰ï¼Œå°‡ "Image_Data" è½‰ç‚º "Compressed_Image"ã€‚
4.  **UI åŸ·è¡Œç·’**ï¼šé¡¯ç¤º "åœ–ç‰‡è™•ç†å®Œæˆ: Compressed_Image"ã€‚

**æç¤º**ï¼š
ä½ éœ€è¦ä¸€å€‹ `runBlocking` ä¾†æ¨¡æ“¬ä¸»ç¨‹å¼ï¼Œä½†åœ¨ `runBlocking` å…§éƒ¨ï¼Œè©¦è‘—ç”¨ `launch` å’Œ `withContext` ä¾†å®Œæˆåˆ‡æ›ã€‚
*(æ³¨æ„ï¼šåœ¨å–®ç´”çš„ JVM å°ˆæ¡ˆä¸­æ²’æœ‰ `Dispatchers.Main`ï¼Œä½ å¯ä»¥ç”¨ `Dispatchers.Default` ä»£æ›¿ Mainï¼Œæˆ–è€…å¼•å…¥ `kotlinx-coroutines-swing`ï¼Œä½†åœ¨ç·´ç¿’ä¸­åªè¦çœ‹åˆ°åŸ·è¡Œç·’åå­—æœ‰è®Šå³å¯)*

---

æ˜å¤© **Day 5**ï¼Œæˆ‘å€‘è¦é€²å…¥å”ç¨‹æœ€æ ¸å¿ƒã€ä¹Ÿæ˜¯æœ€å®¹æ˜“è¢«å¿½ç•¥çš„è¨­è¨ˆå“²å­¸ï¼š**çµæ§‹åŒ–ä¸¦ç™¼ (Structured Concurrency)**ã€‚ç‚ºä»€éº¼å–æ¶ˆçˆ¶å”ç¨‹ï¼Œå­å”ç¨‹å°±æœƒè‡ªå‹•å–æ¶ˆï¼Ÿé€™å°æ–¼é˜²æ­¢ Memory Leak è‡³é—œé‡è¦ï¼
